{% assign raw_segments = page.url | split:'/' | reject:' ' %}
{% assign path = '' %}
{% assign last_index = raw_segments.size | minus: 1 %}

<nav class="breadcrumbs" aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
  <ol>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="/" itemprop="item"><span itemprop="name">Home</span></a>
      <meta itemprop="position" content="1" />
    </li>

    {% for segment in raw_segments %}
      {% if segment != '' %}
        {% assign path = path | append:'/' | append:segment %}
        {% assign index = forloop.index0 | plus: 2 %}

        {% assign name = segment %}
        {% assign seg_lower = segment | downcase %}
        {% assign prev_index = forloop.index0 | minus: 1 %}
        {% assign prev_seg = raw_segments[prev_index] | downcase %}

        {%- comment -%} Priority 1: manual overrides via _data/breadcrumb_map.yml {%- endcomment -%}
        {% if site.data.breadcrumb_map and site.data.breadcrumb_map[seg_lower] %}
          {% assign name = site.data.breadcrumb_map[seg_lower] %}

        {%- comment -%} Priority 2: US states via _data/us_states.yml {%- endcomment -%}
        {% elsif site.data.us_states and site.data.us_states[seg_lower] %}
          {% assign name = site.data.us_states[seg_lower] %}

        {%- comment -%} Priority 3: County fallback if previous segment is a state {%- endcomment -%}
        {% elsif forloop.index0 > 0 and site.data.us_states and site.data.us_states[prev_seg] %}
          {% if seg_lower contains '-county' %}
            {% assign name = seg_lower | replace:'-county','' | replace:'-',' ' | capitalize | append:' County' %}
          {% elsif seg_lower contains '-parish' %}
            {% assign name = seg_lower | replace:'-parish','' | replace:'-',' ' | capitalize | append:' Parish' %}
          {% elsif seg_lower contains '-borough' %}
            {% assign name = seg_lower | replace:'-borough','' | replace:'-',' ' | capitalize | append:' Borough' %}
          {% else %}
            {% assign name = seg_lower | replace:'-',' ' | capitalize | append:' County' %}
          {% endif %}

        {%- comment -%} Priority 4: Generic prettifier fallback {%- endcomment -%}
        {% else %}
          {% assign name = name | replace:'-',' ' | capitalize %}
        {% endif %}

        {% if forloop.index0 == last_index %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
            <span itemprop="name">{{ name }}</span>
            <meta itemprop="position" content="{{ index }}" />
          </li>
        {% else %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ path }}/" itemprop="item"><span itemprop="name">{{ name }}</span></a>
            <meta itemprop="position" content="{{ index }}" />
          </li>
        {% endif %}
      {% endif %}
    {% endfor %}
  </ol>
</nav>
