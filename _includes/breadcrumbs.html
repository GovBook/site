{% comment %}
  GovBook Breadcrumbs â€” V7.4.1 (cleaned + correct linking)
{% endcomment %}

{% comment %} Robustly choose a URL to split into segments (prefer page.url, then permalink, then path). Normalize absolute URLs, strip index pages and extensions, and avoid printing any stray debug/comment text. {% endcomment %}
{% assign base = site.baseurl | default: '' %}
{% if base == '/' %}
  {% assign base = '' %}
{% endif %}

{% assign url = page.url %}
{% if url == nil or url == '' %}
  {% if page.path %}
    {% assign url = page.path %}
  {% elsif page.permalink %}
    {% assign url = page.permalink %}
  {% else %}
    {% assign url = '/' %}
  {% endif %}
{% endif %}

{% if url contains 'http' %}
  {% assign url = url | remove: 'http://' | remove: 'https://' %}
  {% assign url = url | remove: site.url %}
  {% if base != '' %}
    {% assign url = url | remove: base %}
  {% endif %}
  {% assign url = '/' | append: url %}
{% endif %}

{%- comment -%} Strip index pages and file extensions to avoid empty or irrelevant segments {%- endcomment -%}
{% assign url = url | replace: 'index.html','' | replace: 'index.htm','' | replace: 'index.md','' %}
{% assign url = url | replace: '.html','' | replace: '.md','' %}
{% assign url = url | replace: '//' , '/' %}

{% assign raw_segments = url | split:'/' %}

{% assign segments = "" | split:"" %}
{% for s in raw_segments %}
  {% assign s_clean = s | strip %}
  {% if s_clean != "" and s_clean != "nil" %}
    {% assign segments = segments | push: s_clean %}
  {% endif %}
{% endfor %}

{% assign path = base %}
{% assign last_index = segments.size | minus: 1 %}

{% comment %} Determine if this is a US branch once so we can use it inside the loop. {% endcomment %}
{% assign on_us_branch = false %}
{% if segments.size > 0 %}
  {% assign first_seg = segments[0] | downcase %}
  {% if first_seg == 'us' or first_seg == 'united-states' %}
    {% assign on_us_branch = true %}
  {% endif %}
{% endif %}

<nav class="breadcrumbs" aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
  <ol>
    <!-- Home -->
    {% assign home_href = base | append:'/' | replace:'//','/' %}
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="{{ home_href }}" itemprop="item"><span itemprop="name">Home</span></a>
      <meta itemprop="position" content="1" />
    </li>

    {% comment %} Iterate segments and render breadcrumbs {% endcomment %}
    {% for segment in segments %}
      {% assign seg_lower = segment | downcase %}
      {% assign prev_seg = '' %}
      {% if forloop.index0 > 0 %}
        {% assign prev_seg = segments[forloop.index0 | minus: 1] | downcase %}
      {% endif %}

      {% assign path = path | append:'/' | append:segment %}
      {% assign path = path | replace:'//','/' %}
      {% assign index = forloop.index0 | plus: 2 %}
      {% assign is_last = forloop.index0 == last_index %}

      {% assign is_jurisdiction = false %}
      {% assign is_person = false %}

      {% capture titleized %}
        {% assign words = seg_lower | replace:'-',' ' | split:' ' %}
        {% for w in words %}
          {{ w | capitalize }}
        {% endfor %}
      {% endcapture %}
      {% assign name = titleized | strip %}

      {% if on_us_branch %}
        {% assign is_state = site.data.us_states and site.data.us_states[seg_lower] %}
        {% assign prev_is_state = site.data.us_states and site.data.us_states[prev_seg] %}
        {% assign is_independent_city = site.data.independent_cities and site.data.independent_cities[seg_lower] %}
        {% assign prev_is_independent_city = site.data.independent_cities and site.data.independent_cities[prev_seg] %}
        {% assign prev_is_county_like = prev_seg contains '-county' or prev_seg contains '-parish' or prev_seg contains '-borough' %}

        {% if seg_lower == 'us' %}
          {% assign name = 'United States' %}
          {% assign is_jurisdiction = true %}

        {% elsif is_state %}
          {% assign name = site.data.us_states[seg_lower] %}
          {% assign is_jurisdiction = true %}

        {% elsif prev_is_state %}
          {% if prev_seg == 'la' or prev_seg == 'louisiana' %}
            {% assign base = seg_lower | replace:'-parish','' | replace:'-county','' | replace:'-borough','' | replace:'-',' ' %}
            {% capture pretty %}{% assign words = base | split:' ' %}{% for w in words %}{{ w | capitalize }}{% endfor %}{% endcapture %}
            {% assign name = pretty | append:' Parish' %}
          {% elsif prev_seg == 'ak' or prev_seg == 'alaska' %}
            {% assign base = seg_lower | replace:'-borough','' | replace:'-parish','' | replace:'-county','' | replace:'-',' ' %}
            {% capture pretty %}{% assign words = base | split:' ' %}{% for w in words %}{{ w | capitalize }}{% endfor %}{% endcapture %}
            {% assign name = pretty | append:' Borough' %}
          {% elsif seg_lower contains '-county' %}
            {% assign base = seg_lower | replace:'-county','' | replace:'-',' ' %}
            {% capture pretty %}{% assign words = base | split:' ' %}{% for w in words %}{{ w | capitalize }}{% endfor %}{% endcapture %}
            {% assign name = pretty | append:' County' %}
          {% else %}
            {% assign name = name %}
          {% endif %}
          {% assign is_jurisdiction = true %}

        {% elsif is_independent_city %}
          {% assign name = site.data.independent_cities[seg_lower] %}
          {% assign is_jurisdiction = true %}

        {% elsif prev_is_county_like or prev_is_independent_city %}
          {% assign is_jurisdiction = true %}

        {% else %}
          {% if is_last %}
            {% assign is_person = true %}
          {% endif %}
        {% endif %}
      {% endif %}

      {% if is_last %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
          <span itemprop="name">{{ name }} 1</span>
          <meta itemprop="position" content="{{ index }}" />
        </li>
      {% else %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="{{ path | append:'/' | replace:'//','/' }}" itemprop="item"><span itemprop="name">{{ name }}</span></a>
          <meta itemprop="position" content="{{ index }}" />
        </li>
      {% endif %}
    {% endfor %}
  </ol>
</nav>
