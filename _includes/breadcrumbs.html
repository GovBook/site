{% assign raw_segments = page.url | split:'/' %}
{% assign segments = "" | split:"" %}
{% for s in raw_segments %}
  {% if s != "" %}
    {% assign segments = segments | push: s %}
  {% endif %}
{% endfor %}

{% assign path = '' %}
{% assign last_index = segments.size | minus: 1 %}

<nav class="breadcrumbs" aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
  <ol>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="/" itemprop="item"><span itemprop="name">Home</span></a>
      <meta itemprop="position" content="1" />
    </li>

    {% for segment in segments %}
      {% assign seg_lower = segment | downcase %}
      {% assign prev_index = forloop.index0 | minus: 1 %}
      {% assign prev_seg = segments[prev_index] | downcase %}
      {% assign path = path | append:'/' | append:segment %}
      {% assign index = forloop.index0 | plus: 2 %}
      {% assign is_last = forloop.index0 == last_index %}

      {% assign is_state = site.data.us_states and site.data.us_states[seg_lower] %}
      {% assign is_independent_city = site.data.independent_cities and site.data.independent_cities[seg_lower] %}
      {% assign prev_is_state = site.data.us_states and site.data.us_states[prev_seg] %}
      {% assign prev_is_independent_city = site.data.independent_cities and site.data.independent_cities[prev_seg] %}
      {% assign prev_is_county = prev_seg contains '-county' or prev_seg contains '-parish' or prev_seg contains '-borough' %}

      {%- comment -%} Priority 1: manual overrides {%- endcomment -%}
      {% if site.data.breadcrumb_map and site.data.breadcrumb_map[seg_lower] %}
        {% assign name = site.data.breadcrumb_map[seg_lower] %}

      {%- comment -%} Priority 2: country-level US (special case) {%- endcomment -%}
      {% elsif seg_lower == 'us' %}
        {% assign name = "United States" %}

      {%- comment -%} Priority 3: state name {%- endcomment -%}
      {% elsif is_state %}
        {% assign name = site.data.us_states[seg_lower] %}

      {%- comment -%} Priority 4: county/parish/borough {%- endcomment -%}
      {% elsif prev_is_state %}
        {% if prev_seg == 'la' or prev_seg == 'louisiana' %}
          {% assign name = seg_lower | replace:'-parish','' | replace:'-county','' | replace:'-borough','' | replace:'-',' ' | capitalize | append:' Parish' %}
        {% elsif prev_seg == 'ak' or prev_seg == 'alaska' %}
          {% assign name = seg_lower | replace:'-borough','' | replace:'-parish','' | replace:'-county','' | replace:'-',' ' | capitalize | append:' Borough' %}
        {% elsif seg_lower contains '-county' %}
          {% assign name = seg_lower | replace:'-county','' | replace:'-',' ' | capitalize | append:' County' %}
        {% else %}
          {% assign name = seg_lower | replace:'-',' ' | capitalize %}
        {% endif %}

      {%- comment -%} Priority 5: independent city (county-equivalent) {%- endcomment -%}
      {% elsif is_independent_city %}
        {% assign name = site.data.independent_cities[seg_lower] %}

      {%- comment -%} Priority 6: PERSON detection (last segment & not jurisdiction) {%- endcomment -%}
      {% elsif is_last %}
        {% assign name = seg_lower | replace:'-',' ' | capitalize %}
        {% assign is_person = true %}

      {%- comment -%} Priority 7: city underneath county/independent city {%- endcomment -%}
      {% elsif prev_is_county or prev_is_independent_city %}
        {% assign name = seg_lower | replace:'-',' ' | capitalize %}

      {%- comment -%} Priority 8: generic fallback {%- endcomment -%}
      {% else %}
        {% assign name = seg_lower | replace:'-',' ' | capitalize %}
      {% endif %}

      {%- comment -%} Render item (clickable unless last / person) {%- endcomment -%}
      {% if is_last %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
          <span itemprop="name">{{ name }}</span>
          <meta itemprop="position" content="{{ index }}" />
        </li>
      {% else %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="{{ path }}/" itemprop="item"><span itemprop="name">{{ name }}</span></a>
          <meta itemprop="position" content="{{ index }}" />
        </li>
      {% endif %}

    {% endfor %}
  </ol>
</nav>
